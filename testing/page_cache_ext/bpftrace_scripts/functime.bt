#!/usr/bin/env bpftrace

// Define maps for start times and total execution times
BEGIN {
    printf("Tracing function execution times for multiple functions...\n");
}

// Replace 'shrink_lruvec' and 'get_page_cache_ext_ops' with your target functions
kprobe:shrink_lruvec {
    @start[pid, "shrink_lruvec"] = nsecs;
}

kretprobe:shrink_lruvec /@start[pid, "shrink_lruvec"]/{
    $duration = nsecs - @start[pid, "shrink_lruvec"];
    @totalTime["shrink_lruvec"] = sum($duration);
    delete(@start[pid, "shrink_lruvec"]);
}

kprobe:get_page_cache_ext_ops {
    @start[pid, "get_page_cache_ext_ops"] = nsecs;
}

kretprobe:get_page_cache_ext_ops /@start[pid, "get_page_cache_ext_ops"]/{
    $duration = nsecs - @start[pid, "get_page_cache_ext_ops"];
    @totalTime["get_page_cache_ext_ops"] = sum($duration);
    delete(@start[pid, "get_page_cache_ext_ops"]);
}

END {
    // Print total execution times for each function
    printf("Total execution times:\n");
    print(@totalTime);
    clear(@start); // Clear start times map
}
